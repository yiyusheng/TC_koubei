source('~/Code/R/TC_koubei/data_load.R')
source('~/Code/R/TC_koubei/data_load.R')
fname <- list.files(dir_data)
fname
shop_info <- read.csv(file = file.path(dir_data,'shop_info.txt'))
shop_info <- read.csv(file = file.path(dir_data,'datasets','shop_info.txt'))
shop_info <- read.csv(file = file.path(dir_data,'datasets','shop_info.txt'),header = F)
shop_info <- read.csv(file = file.path(dir_data,'datasets','shop_info.txt'),
col.names = c('shop_id','city_name','location_id','per_pay','sorce',
'comment_cnt','shop_level','cate_1_name','cate_2_name','cate_3_name'))
shop_info <- read.csv(file = file.path(dir_data,'datasets','shop_info.txt'),header = F,
col.names = c('shop_id','city_name','location_id','per_pay','sorce',
'comment_cnt','shop_level','cate_1_name','cate_2_name','cate_3_name'))
user_pay <- read.csv(file = file.path(dir_data,'datasets','user_pay.txt'),header = F,
col.names = c('user_id','shop_id','time_stamp'))
source('~/Code/R/TC_koubei/data_load.R')
source('~/Code/R/TC_koubei/data_load.R')
length(unique(shop_info$location_id))
ggplot()
source('~/Code/R/TC_koubei/sta.R')
sta_city_location <- tapply(shop_info$location_id,shop_info$city_name,length)
# A2. location and shop
sta_location_shop <- tapply(shop_info$shop_id,shop_info$location_id,length)
# A3. city and shop
sta_city_shop <- tapply(shop_info$shop_id,shop_info$city_name,length)
sta_city_shop
sta_city_location <- melt(tapply(shop_info$location_id,shop_info$city_name,length))
# A2. location and shop
sta_location_shop <- melt(tapply(shop_info$shop_id,shop_info$location_id,length))
# A3. city and shop
sta_city_shop <- melt(tapply(shop_info$shop_id,shop_info$city_name,length))
View(sta_city_location)
View(sta_city_shop)
View(sta_location_shop)
View(sta_city_location)
View(sta_city_shop)
sta_city_location <- melt(tapply(shop_info$location_id,shop_info$city_name,length))
sta_city_shop <- melt(tapply(shop_info$shop_id,shop_info$city_name,length))
sta_city_location <- melt(tapply(shop_info$location_id,shop_info$city_name,length))
sta_city_shop <- melt(tapply(shop_info$shop_id,shop_info$city_name,length))
all.equal(sta_city_location,sta_city_shop)
View(sta_location_shop)
sta_city_location <- melt(tapply(shop_info$location_id,shop_info$city_name,length))
sta_city_shop <- melt(tapply(shop_info$shop_id,shop_info$city_name,length))
a <- subset(shop_info,city_name == '武汉')
length(unique(a$location_id))
rm(sta_city_location)
sta_city_location <- melt(tapply(shop_info$location_id,shop_info$city_name,length))
View(sta_city_location)
sta_city_location <- melt(tapply(shop_info$location_id,shop_info$city_name,function(x)length(unique(x))))
# A2. location and shop
sta_location_shop <- melt(tapply(shop_info$shop_id,shop_info$location_id,function(x)length(unique(x))))
# A3. city and shop
sta_city_shop <- melt(tapply(shop_info$shop_id,shop_info$city_name,function(x)length(unique(x))))
View(sta_city_location)
View(sta_city_shop)
View(shop_info)
View(sta_location_shop)
View(sta_city_shop)
View(sta_city_location)
quantileX(sta_city_shop$value)
sum(sta_city_shop$value[sta_city_shop$value > 15])
sum(sta_city_shop$value[sta_city_shop$value > 15])/2000
View(a)
table(shop_info$shop_level)
sta_uid_time <- melt(table(user_view$user_id))
quantileX(sta_uid_time$value)
sta_shopB <- melt(table(user_view$shop_id))
quantileX(sta_shopB$value)
ggplot(sta_shopB,aes(x = value)) + geom_histogram(binwidth = 100)
summary(sta_shopB$value)
sta_timeB <- melt(table(as.Date(user_view$time_stamp)))
ggplot(sta_timeB,aes(x = value)) + geom_histogram(binwidth = 1)
View(sta_timeB)
ggplot(sta_timeB,aes(x = Var1,y = value)) + geom_line()
ggplot(sta_timeB,aes(x = as.p(Var1),y = value)) + geom_line()
tmp <- difftime(user_view$time_stamp,as.Date(user_view$time_stamp),tz = 'UTC')
head(tmp)
tmp <- as.POSIXct(difftime(user_view$time_stamp,as.Date(user_view$time_stamp),tz = 'UTC'),tz = 'UTC',origin = '1970-01-01')
summary(user_view$time_stamp)
tmp <- difftime(user_view$time_stamp,as.Date(user_view$time_stamp),tz = 'UTC') + as.p('2016-11-01')
summary(tmp)
sta_hourB <- melt(table(format(user_view$time_stamp,'%H')))
ggplot(sta_hourB,aes(x = Var1,y = value)) + geom_line()
nrow(a)
nrow(aasdf)
norw(list)
nrow(list)
nrow(a)
nrow(tmp)
source('~/Code/R/TC_koubei/tsModel.R')
summary(user_pay)
test_start <- as.p('2016-11-01') - 14*86400
test_end <- as.p('2016-11-01')
sid <- 110
data_shop_up <- subset(user_pay,shop_id == sid)
gen_start <- test_start
gen_end <- test_end
data_shop_up <- subset(user_pay,shop_id == sid & time_stamp >= gen_start & time_stamp < gen_end)
time_interval <- 86400
time_interval <- 86400;gen_start <- test_start;gen_end <- test_end
as.numeric(data_shop_up$time_stamp[1:10])
data_shop_up$uni_time <- ceil(as.numeric(data_shop_up$time_stamp)/interval)*interval
data_shop_up$uni_time <- as.POSIXct(floor(as.numeric(data_shop_up$time_stamp)/interval)*interval,tz = 'UTC',origin = '1970-01-01')
data_shop_up$uni_time <- as.POSIXct(floor(as.numeric(data_shop_up$time_stamp)/time_interval)*time_interval,tz = 'UTC',origin = '1970-01-01')
View(data_shop_up)
time_interval <- 86400/2;gen_start <- test_start;gen_end <- test_end
data_shop_up <- subset(user_pay,shop_id == sid & time_stamp >= gen_start & time_stamp < gen_end)
data_shop_up$uni_time <- as.POSIXct(floor(as.numeric(data_shop_up$time_stamp)/time_interval)*time_interval,tz = 'UTC',origin = '1970-01-01')
View(data_shop_up)
data_shop_up$uni_time <- as.POSIXct(floor(as.numeric(data_shop_up$time_stamp)+1/time_interval)*time_interval,tz = 'UTC',origin = '1970-01-01')
data_shop_up$uni_time <- as.POSIXct(floor((as.numeric(data_shop_up$time_stamp)+1)/time_interval)*time_interval,tz = 'UTC',origin = '1970-01-01')
data_shop_up$uni_time <- as.POSIXct(floor(as.numeric(data_shop_up$time_stamp)/time_interval)*time_interval,tz = 'UTC',origin = '1970-01-01')
r <- tapply(data_shop_up$user_id,list(data_shop_up$shop_id,data_shop_up$uni_time),length)
r
list(data_shop_up$shop_id,data_shop_up$uni_time)
a <- list(data_shop_up$shop_id,data_shop_up$uni_time)
names(r)
unique(a)
?aggregate
r <- aggregate(data_shop_up,by = c('shop_id','uni_time'),FUN = length)
r <- aggregate(data_shop_up,by = list('shop_id','uni_time'),FUN = length)
r <- aggregate(data_shop_up$user_id,by = list(data_shop_up$shop_id,data_shop_up$uni_time),FUN = length)
View(r)
time_interval <- 86400;gen_start <- test_start;gen_end <- test_end
data_shop_up$uni_time <- as.POSIXct(floor(as.numeric(data_shop_up$time_stamp)/time_interval)*time_interval,tz = 'UTC',origin = '1970-01-01')
r <- aggregate(data_shop_up$user_id,by = list(data_shop_up$shop_id,data_shop_up$uni_time),FUN = length)
View(r)
time_interval <- 86400;gen_start <- test_start;gen_end <- test_end
data_shop_up <- subset(user_pay,time_stamp >= gen_start & time_stamp < gen_end)
data_shop_up$uni_time <- as.POSIXct(floor(as.numeric(data_shop_up$time_stamp)/time_interval)*time_interval,tz = 'UTC',origin = '1970-01-01')
r <- aggregate(data_shop_up$user_id,by = list(data_shop_up$shop_id,data_shop_up$uni_time),FUN = length)
View(r)
names(r) <- c('shop_id','uni_time','value')
r <- r[order(r$shop_id,r$uni_time),]
View(r)
shop_pay <- aggregate(data_shop_up$user_id,by = list(data_shop_up$shop_id,data_shop_up$uni_time),FUN = length)
names(shop_pay) <- c('shop_id','uni_time','value')
shop_pay <- shop_pay[order(shop_pay$shop_id,shop_pay$uni_time),]
shop_pay_split <- split(shop_pay,shop_pay$shop_id)
df <- shop_pay_split[[110]]
View(df)
p <- ggplot(df,aes(x = uni_time,y = value)) + geom_line() + ggtitle(paste('shop',df$shop_id[1],sep='_')) +
xlab('time') + ylab('number of user payed')
print(p)
min(user_pay$time_stamp)
time_interval <- 86400;gen_start <- as.p('2015-06-26');gen_end <- as.p('2016-11-01')
data_shop_up <- subset(user_pay,time_stamp >= gen_start & time_stamp < gen_end)
data_shop_up$uni_time <- as.POSIXct(floor(as.numeric(data_shop_up$time_stamp)/time_interval)*time_interval,tz = 'UTC',origin = '1970-01-01')
shop_pay <- aggregate(data_shop_up$user_id,by = list(data_shop_up$shop_id,data_shop_up$uni_time),FUN = length)
save(shop_pay,file = file.path(dir_data,'shop_pay.Rda'))
View(shop_pay)
names(shop_pay) <- c('shop_id','uni_time','value')
shop_pay <- shop_pay[order(shop_pay$shop_id,shop_pay$uni_time),]
save(shop_pay,file = file.path(dir_data,'shop_pay.Rda'))
View(shop_pay)
shop_pay_split <- split(shop_pay,shop_pay$shop_id)
object.size(shop_pay)
df <- shop_pay_split[222]
p <- ggplot(df,aes(x = uni_time,y = value)) + geom_line() + ggtitle(paste('shop',df$shop_id[1],sep='_')) +
xlab('time') + ylab('number of user payed')
df <- shop_pay_split[[222]]
p <- ggplot(df,aes(x = uni_time,y = value)) + geom_line() + ggtitle(paste('shop',df$shop_id[1],sep='_')) +
xlab('time') + ylab('number of user payed')
p
p <- ggplot(df,aes(x = uni_time,y = value)) + geom_line() + ggtitle(paste('shop',df$shop_id[1],sep='_')) +
xlab('time') + ylab('number of user payed') + scale_x_continuous(breaks = 86400*30)
ggsave(file = file.path(dir_data,'shop_pay',paste('shop_',df$shop_id[1],'.jpg',sep='')),
plot = p,width = 12,height = 8,dpi = 100)
p <- ggplot(df,aes(x = uni_time,y = value)) + geom_line() + ggtitle(paste('shop',df$shop_id[1],sep='_')) +
xlab('time') + ylab('number of user paid')
p
file.path(dir_data,'shop_pay',paste('shop_',df$shop_id[1],'.jpg',sep=''))
ggsave(file = file.path(dir_data,'shop_pay',paste('shop_',df$shop_id[1],'.jpg',sep='')),
plot = p,width = 12,height = 8,dpi = 100)
plot_shop_pay <- function(shop_pay){
shop_pay_split <- split(shop_pay,shop_pay$shop_id)
lapply(shop_pay_split,function(df){
p <- ggplot(df,aes(x = uni_time,y = value)) + geom_line() + ggtitle(paste('shop',df$shop_id[1],sep='_')) +
xlab('time') + ylab('number of user paid')
ggsave(file = file.path(dir_data,'shop_pay',paste('shop_',df$shop_id[1],'.jpg',sep='')),
plot = p,width = 12,height = 8,dpi = 100)
})
}
shop_pay_split <- split(shop_pay,shop_pay$shop_id)
lapply(shop_pay_split,function(df){
p <- ggplot(df,aes(x = uni_time,y = value)) + geom_line() + ggtitle(paste('shop',df$shop_id[1],sep='_')) +
xlab('time') + ylab('number of user paid')
ggsave(file = file.path(dir_data,'shop_pay',paste('shop_',df$shop_id[1],'.jpg',sep='')),
plot = p,width = 12,height = 8,dpi = 100)
})
lapply(shop_pay_split,function(df){
df <- subset(df,time_stamp >=test_start & time_stamp < test_end)
p <- ggplot(df,aes(x = uni_time,y = value)) + geom_line() + ggtitle(paste('shop',df$shop_id[1],sep='_')) +
xlab('time') + ylab('number of user paid')
ggsave(file = file.path(dir_data,'shop_pay',paste('shop_',df$shop_id[1],'.jpg',sep='')),
plot = p,width = 12,height = 8,dpi = 100)
})
lapply(shop_pay_split,function(df){
df <- subset(df,uni_time >=test_start & uni_time < test_end)
p <- ggplot(df,aes(x = uni_time,y = value)) + geom_line() + ggtitle(paste('shop',df$shop_id[1],sep='_')) +
xlab('time') + ylab('number of user paid')
ggsave(file = file.path(dir_data,'shop_pay',paste('shop_',df$shop_id[1],'.jpg',sep='')),
plot = p,width = 12,height = 8,dpi = 100)
})
data_shop_uv <- subset(user_view,time_stamp >= gen_start & time_stamp < gen_end)
data_shop_uv$uni_time <- as.POSIXct(floor(as.numeric(data_shop_uv$time_stamp)/time_interval)*time_interval,tz = 'UTC',origin = '1970-01-01')
shop_view <- aggregate(data_shop_uv$user_id,by = list(data_shop_uv$shop_id,data_shop_uv$uni_time),FUN = length)
names(shop_view) <- c('shop_id','uni_time','value')
shop_view <- shop_view[order(shop_view$shop_id,shop_view$uni_time),]
save(shop_view,file = file.path(dir_data,'shop_view.Rda'))
View(shop_view)
source('~/Code/R/TC_koubei/data_load.R')
rm(list = ls())
source('head.R')
load(file.path(dir_data,'shop_info.Rda'))
load(file.path(dir_data,'shop_pay.Rda'))
load(file.path(dir_data,'shop_view.Rda'))
# F1. coefficient of correlation between view and pay
shop <- merge(shop_pay,shop_view,by = c('shop_id','uni_time'),all = T)
shop <- subset(shop,uni_time >= as.p('2016-02-01'))
names(shop) <- c('shop_id','uni_time','numPay','numView')
shop$shop_id <- factor(shop$shop_id)
shop[is.na(shop)] <- 0
corr_pay_view <- data.frame(shop_id = levels(shop$shop_id),
corr = as.numeric(by(shop[,c('numPay','numView')],factor(shop$shop_id),function(df)cor(df$numPay,df$numView))))
corr_pay_view$corr[is.na(corr_pay_view$corr)] <- 0
shop_pay$wday <- as.POSIXlt(shop_pay$uni_time)$wday
shop_pay$wday <- as.POSIXlt(shop_pay$uni_time)$wday
shop_pay$mday <- as.POSIXlt(shop_pay$uni_time)$mday
shop_view$wday <- as.POSIXlt(shop_view$uni_time)$wday
shop_view$mday <- as.POSIXlt(shop_view$uni_time)$mday
shop_pay$shop_id <- factor(shop_pay$shop_id)
shop_view$shop_id <- factor(shop_view$shop_id)
shop_pay$shop_id <- factor(shop_pay$shop_id)
shop_view$shop_id <- factor(shop_view$shop_id)
?aggregate
view_wday <- aggregate(shop_id + wday,data = shop_view,FUN = mean)
view_wday <- aggregate(shop_view[,c('shop_id','wday','value')],by = list('shop_id','wday'),mean)
view_wday <- aggregate(shop_view$value,by = list(shop_view$shop_id,shop_view$wday),mean)
pay_wday <- aggregate(shop_pay$value,by = list(shop_pay$shop_id,shop_pay$wday),mean)
pay_mday <- aggregate(shop_pay$value,by = list(shop_pay$shop_id,shop_pay$wday),mean)
view_wday <- aggregate(shop_view$value,by = list(shop_view$shop_id,shop_view$wday),mean)
view_mday <- aggregate(shop_view$value,by = list(shop_view$shop_id,shop_view$mday),mean)
View(pay_mday)
pay_wday <- dcast(Group.1~Group.2,value.var = 'x')
pay_wday <- dcast(Group.1~Group.2,data = pay_wday,value.var = 'x')
View(pay_mday)
View(pay_wday)
pay_mday <- dcast(Group.1~Group.2,data = pay_mday,value.var = 'x')
view_wday <- dcast(Group.1~Group.2,data = view_wday,value.var = 'x')
view_mday <- dcast(Group.1~Group.2,data = view_mday,value.var = 'x')
View(view_mday)
View(pay_wday)
View(view_wday)
View(pay_wday)
names(pay_wday)[1] <- 'shop_id'
names(pay_mday)[1] <- 'shop_id'
names(view_wday)[1] <- 'shop_id'
names(view_mday)[1] <- 'shop_id'
pay_wday <- revise_name(pay_wday,'pwday')
revise_name(df,prefix){
len <- ncol(df)
names(df) <- c('shop_id',paste(prefix,names(df)[2:len]))
}
revise_name(df,prefix){
len <- ncol(df)
revise_name <- function(df,prefix){
len <- ncol(df)
names(df) <- c('shop_id',paste(prefix,names(df)[2:len],sep=''))
}
pay_wday <- revise_name(pay_wday,'pwday')
pay_mday <- revise_name(pay_mday,'pmday')
pay_wday <- aggregate(shop_pay$value,by = list(shop_pay$shop_id,shop_pay$wday),mean)
pay_mday <- aggregate(shop_pay$value,by = list(shop_pay$shop_id,shop_pay$wday),mean)
view_wday <- aggregate(shop_view$value,by = list(shop_view$shop_id,shop_view$wday),mean)
view_mday <- aggregate(shop_view$value,by = list(shop_view$shop_id,shop_view$mday),mean)
pay_wday <- dcast(Group.1~Group.2,data = pay_wday,value.var = 'x')
pay_mday <- dcast(Group.1~Group.2,data = pay_mday,value.var = 'x')
view_wday <- dcast(Group.1~Group.2,data = view_wday,value.var = 'x')
view_mday <- dcast(Group.1~Group.2,data = view_mday,value.var = 'x')
revise_name <- function(df,prefix){
len <- ncol(df)
names(df) <- c('shop_id',paste(prefix,names(df)[2:len],sep=''))
}
names(pay_wday) <- revise_name(pay_wday,'pwday')
names(pay_mday) <- revise_name(pay_mday,'pmday')
names(view_wday) <- revise_name(view_wday,'vwday')
names(view_mday) <- revise_name(view_mday,'vmday')
pay_wday <- aggregate(shop_pay$value,by = list(shop_pay$shop_id,shop_pay$wday),mean)
pay_mday <- aggregate(shop_pay$value,by = list(shop_pay$shop_id,shop_pay$wday),mean)
view_wday <- aggregate(shop_view$value,by = list(shop_view$shop_id,shop_view$wday),mean)
view_mday <- aggregate(shop_view$value,by = list(shop_view$shop_id,shop_view$mday),mean)
pay_wday <- dcast(Group.1~Group.2,data = pay_wday,value.var = 'x')
pay_mday <- dcast(Group.1~Group.2,data = pay_mday,value.var = 'x')
view_wday <- dcast(Group.1~Group.2,data = view_wday,value.var = 'x')
view_mday <- dcast(Group.1~Group.2,data = view_mday,value.var = 'x')
pay_wday <- aggregate(shop_pay$value,by = list(shop_pay$shop_id,shop_pay$wday),mean)
pay_mday <- aggregate(shop_pay$value,by = list(shop_pay$shop_id,shop_pay$mday),mean)
view_wday <- aggregate(shop_view$value,by = list(shop_view$shop_id,shop_view$wday),mean)
view_mday <- aggregate(shop_view$value,by = list(shop_view$shop_id,shop_view$mday),mean)
pay_wday <- dcast(Group.1~Group.2,data = pay_wday,value.var = 'x')
pay_mday <- dcast(Group.1~Group.2,data = pay_mday,value.var = 'x')
view_wday <- dcast(Group.1~Group.2,data = view_wday,value.var = 'x')
view_mday <- dcast(Group.1~Group.2,data = view_mday,value.var = 'x')
names(pay_wday) <- revise_name(pay_wday,'pwday')
names(pay_mday) <- revise_name(pay_mday,'pmday')
names(view_wday) <- revise_name(view_wday,'vwday')
names(view_mday) <- revise_name(view_mday,'vmday')
source('~/Code/R/TC_koubei/feature_static.R')
View(shop_info)
rm(list = ls())
source('head.R')
load(file.path(dir_data,'shop_info.Rda'))
load(file.path(dir_data,'shop_pay.Rda'))
load(file.path(dir_data,'shop_view.Rda'))
load(file.path(dir_data,'data_load_A.Rda'))
# F1. numbers of repeating customer (number of customers who paid for the same shop in a period[weeks/month])
user_pay_day <- user_pay
user_pay_day$time_stamp <- as.Date(user_pay_day$time_stamp)
user_pay_day$shop_id <- factor(user_pay_day$shop_id)
split_user_pd <- split(user_pay_day,user_pay_day$shop_id)
