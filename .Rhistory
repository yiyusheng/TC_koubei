data_pred_expand <- do.call(rbind,data_pred_expand)
}
add_real <- function(data_pred){
data_pred <- subset(data_pred,uni_time >= test_start & uni_time < test_end)
data_real <- subset(shop_pay,uni_time >= test_start & uni_time < test_end)
data_comp <- merge(data_real,data_pred,by = c('shop_id','uni_time'))
names(data_comp) <- c('shop_id','uni_time','value','pred')
data_comp
}
expand_last_kdays <- function(k = 7){
data_pred <- extract_data(shop_pay)
data_pred <- clear_data(data_pred)
data_pred <- expand_data(data_pred,k)
data_comp <- add_real(data_pred)
cat(sprintf('Last %.0f days\t',k))
if(nrow(data_comp) == 0){
return(data_pred)
}else{
r <- check_result(data_comp)
return(list(r,data_comp))
}
}
# E1.last 14 days
r14 <- expand_last_kdays(14)
# E2.last 7 days
r7 <- expand_last_kdays(7)
# E3.generate result
r7a <- dcast(shop_id~uni_time,data = r7,value.var = 'value')
names(r7a) <- c('shop_id',paste('day_',1:14,sep=''))
tmp_1707 <- shop_pay$value[shop_pay$shop_id == '1707' &
shop_pay$uni_time >= as.p('2016-10-18') &
shop_pay$uni_time < as.p('2016-10-25')]
tmp_1824 <- shop_pay$value[shop_pay$shop_id == '1824' &
shop_pay$uni_time >= as.p('2016-10-04') &
shop_pay$uni_time < as.p('2016-10-11')]
r7a <- rbind(r7a,
c(1707,tmp_1707,tmp_1707),
c(1824,tmp_1824,tmp_1824))
r7a <- r7a[order(r7a$shop_id),]
write.table(r7a,file = file.path(dir_data,'0208a.csv'),quote = F,sep=',',row.names = F,col.names = F)
data_pred <- subset(shop_pay,uni_time >= (test_start - 86400*k) & uni_time < test_start)
broken_shop <- dcast(shop_id~uni_time,data = data_pred,value.var = 'value')
broken_shop$num_na <- apply(broken_shop,1,function(x)sum(is.na(x)))
missing_shop <- c(broken_shop$shop_id[broken_shop$num_na >= 3],
setdiff(unique(shop_pay$shop_id),unique(data_pred$shop_id)))
data_pred <- subset(shop_pay,uni_time >= (test_start - 86400*k) & uni_time < test_start)
broken_shop <- dcast(shop_id~uni_time,data = data_pred,value.var = 'value')
broken_shop$num_na <- apply(broken_shop,1,function(x)sum(is.na(x)))
missing_shop <- c(broken_shop$shop_id[broken_shop$num_na >= 3],
setdiff(unique(shop_pay$shop_id),unique(data_pred$shop_id)))
weekday_end <- as.POSIXlt(test_end - 86400)$wday
missing_data <- lapply(missing_shop,function(i){
shop_data <- subset(shop_pay,shop_id == i & uni_time < (test_start - 86400*k))
last_day <- max(shop_data$uni_time[as.POSIXlt(shop_data$uni_time)$wday == weekday_end]) + 86400
md <- subset(shop_data,uni_time < last_day & uni_time >= (last_day - 86400*k))
md <- md[order(md$uni_time),]
md$uni_time <- seq.POSIXt(test_start - 86400*k,test_start-86400,by = 'day')
md
})
missing_data <- lapply(missing_shop,function(i){
cat(srpintf('%f',i))
shop_data <- subset(shop_pay,shop_id == i & uni_time < (test_start - 86400*k))
last_day <- max(shop_data$uni_time[as.POSIXlt(shop_data$uni_time)$wday == weekday_end]) + 86400
md <- subset(shop_data,uni_time < last_day & uni_time >= (last_day - 86400*k))
md <- md[order(md$uni_time),]
md$uni_time <- seq.POSIXt(test_start - 86400*k,test_start-86400,by = 'day')
md
})
missing_data <- lapply(missing_shop,function(i){
cat(sprintf('%f',i))
shop_data <- subset(shop_pay,shop_id == i & uni_time < (test_start - 86400*k))
last_day <- max(shop_data$uni_time[as.POSIXlt(shop_data$uni_time)$wday == weekday_end]) + 86400
md <- subset(shop_data,uni_time < last_day & uni_time >= (last_day - 86400*k))
md <- md[order(md$uni_time),]
md$uni_time <- seq.POSIXt(test_start - 86400*k,test_start-86400,by = 'day')
md
})
missing_data <- lapply(missing_shop,function(i){
cat(sprintf('%f\t',i))
shop_data <- subset(shop_pay,shop_id == i & uni_time < (test_start - 86400*k))
last_day <- max(shop_data$uni_time[as.POSIXlt(shop_data$uni_time)$wday == weekday_end]) + 86400
md <- subset(shop_data,uni_time < last_day & uni_time >= (last_day - 86400*k))
md <- md[order(md$uni_time),]
md$uni_time <- seq.POSIXt(test_start - 86400*k,test_start-86400,by = 'day')
md
})
missing_shop
i <- 1464
cat(sprintf('%f\t',i))
shop_data <- subset(shop_pay,shop_id == i & uni_time < (test_start - 86400*k))
last_day <- max(shop_data$uni_time[as.POSIXlt(shop_data$uni_time)$wday == weekday_end]) + 86400
View(shop_data)
md <- subset(shop_data,uni_time < last_day & uni_time >= (last_day - 86400*k))
cat(sprintf('%f\t',i))
shop_data <- subset(shop_pay,shop_id == i & uni_time < (test_start - 86400*k))
last_day <- max(shop_data$uni_time[as.POSIXlt(shop_data$uni_time)$wday == weekday_end]) + 86400
md <- subset(shop_data,uni_time < last_day & uni_time >= (last_day - 86400*k))
md <- md[order(md$uni_time),]
last_day
test_start
md$uni_time <- md$uni_time + test_start - last_day
test_start - last_day
md$uni_time <- md$uni_time + difftime(test_start,last_day,units = 'secs')
missing_data <- lapply(missing_shop,function(i){
cat(sprintf('%f\t',i))
shop_data <- subset(shop_pay,shop_id == i & uni_time < (test_start - 86400*k))
last_day <- max(shop_data$uni_time[as.POSIXlt(shop_data$uni_time)$wday == weekday_end]) + 86400
md <- subset(shop_data,uni_time < last_day & uni_time >= (last_day - 86400*k))
md$uni_time <- md$uni_time + difftime(test_start,last_day,units = 'secs')
# md <- md[order(md$uni_time),]
# md$uni_time <- seq.POSIXt(test_start - 86400*k,test_start-86400,by = 'day')
md
})
missing_data <- do.call(rbind,missing_data)
View(missing_data)
View(data_pred)
data_pred <- subset(shop_pay,uni_time >= (test_start - 86400*k) & uni_time < test_start)
broken_shop <- dcast(shop_id~uni_time,data = data_pred,value.var = 'value')
broken_shop$num_na <- apply(broken_shop,1,function(x)sum(is.na(x)))
missing_shop <- c(broken_shop$shop_id[broken_shop$num_na >= 3],
setdiff(unique(shop_pay$shop_id),unique(data_pred$shop_id)))
weekday_end <- as.POSIXlt(test_end - 86400)$wday
missing_data <- lapply(missing_shop,function(i){
cat(sprintf('%f\t',i))
shop_data <- subset(shop_pay,shop_id == i & uni_time < (test_start - 86400*k))
last_day <- max(shop_data$uni_time[as.POSIXlt(shop_data$uni_time)$wday == weekday_end]) + 86400
md <- subset(shop_data,uni_time < last_day & uni_time >= (last_day - 86400*k))
md$uni_time <- md$uni_time + difftime(test_start,last_day,units = 'secs')
# md <- md[order(md$uni_time),]
# md$uni_time <- seq.POSIXt(test_start - 86400*k,test_start-86400,by = 'day')
md
})
missing_data <- do.call(rbind,missing_data)
data_pred <- rbind(data_pred,missing_data)
extract_data <- function(shop_pay){
data_pred <- subset(shop_pay,uni_time >= (test_start - 86400*k) & uni_time < test_start)
broken_shop <- dcast(shop_id~uni_time,data = data_pred,value.var = 'value')
broken_shop$num_na <- apply(broken_shop,1,function(x)sum(is.na(x)))
missing_shop <- c(broken_shop$shop_id[broken_shop$num_na >= 3],
setdiff(unique(shop_pay$shop_id),unique(data_pred$shop_id)))
weekday_end <- as.POSIXlt(test_end - 86400)$wday
missing_data <- lapply(missing_shop,function(i){
shop_data <- subset(shop_pay,shop_id == i & uni_time < (test_start - 86400*k))
last_day <- max(shop_data$uni_time[as.POSIXlt(shop_data$uni_time)$wday == weekday_end]) + 86400
md <- subset(shop_data,uni_time < last_day & uni_time >= (last_day - 86400*k))
md$uni_time <- md$uni_time + difftime(test_start,last_day,units = 'secs')
md
})
missing_data <- do.call(rbind,missing_data)
data_pred <- rbind(data_pred,missing_data)
}
a <- dcast(shop_id~uni_time,data = data_pred,value.var = 'value')
a$num_na <- apply(a,1,function(x)sum(is.na(x)))
View(a)
View(data_pred)
a <- dcast(shop_id~uni_time,data = data_pred,value.var = 'value')
a <- dcast(shop_id~uni_time,data = data_pred,value.var = 'value')
data_pred <- subset(shop_pay,uni_time >= (test_start - 86400*k) & uni_time < test_start)
broken_shop <- dcast(shop_id~uni_time,data = data_pred,value.var = 'value')
broken_shop$num_na <- apply(broken_shop,1,function(x)sum(is.na(x)))
missing_shop <- c(broken_shop$shop_id[broken_shop$num_na >= 3],
setdiff(unique(shop_pay$shop_id),unique(data_pred$shop_id)))
weekday_end <- as.POSIXlt(test_end - 86400)$wday
missing_data <- lapply(missing_shop,function(i){
shop_data <- subset(shop_pay,shop_id == i & uni_time < (test_start - 86400*k))
last_day <- max(shop_data$uni_time[as.POSIXlt(shop_data$uni_time)$wday == weekday_end]) + 86400
md <- subset(shop_data,uni_time < last_day & uni_time >= (last_day - 86400*k))
md$uni_time <- md$uni_time + difftime(test_start,last_day,units = 'secs')
md
})
missing_data <- do.call(rbind,missing_data)
data_pred <- rbind(subset(data_pred,!(shop_id %in% missing_shop)),missing_data)
a <- dcast(shop_id~uni_time,data = data_pred,value.var = 'value')
View(a)
a$num_na <- apply(a,1,function(x)sum(is.na(x)))
View(a)
a$mean <- apply(a,1,mean)
a$sd <- apply(a,1,sd)
View(a)
sum(x > mean(x) - sd(x)*3 & x < mean(x) + sd(x)*3)
a$mean <- apply(a,1,mean)
a$sd <- apply(a,1,sd)
a$exceed_sd <- apply(a,1,function(x){
sum(x > mean(x) - sd(x)*3 & x < mean(x) + sd(x)*3)
})
View(a)
a$exceed_sd <- apply(a,1,function(x){
sum(x < mean(x) - sd(x)*3 | x > mean(x) + sd(x)*3)
})
View(a)
a$exceed_sd <- apply(a,1,function(x){
sum(x < mean(x) - sd(x)*2 | x > mean(x) + sd(x)*2)
})
View(a)
a$exceed_sd <- apply(a,1,function(x){
sum(x < mean(x) - sd(x)*1.5 | x > mean(x) + sd(x)*1.5)
})
data_pred_dcast <- dcast(shop_id~uni_time,data = data_pred,value.var = 'value')
data_pred_dcast$num_na <- apply(data_pred_dcast,1,function(x)sum(is.na(x)))
data_pred_dcast$mean <- apply(data_pred_dcast,1,mean)
data_pred_dcast$sd <- apply(data_pred_dcast,1,sd)
data_pred_dcast$exceed_sd <- apply(data_pred_dcast,1,function(x){
sum(x < mean(x) - sd(x)*1.5 | x > mean(x) + sd(x)*1.5)
})
View(data_pred_dcast)
a <- data_pred[data_pred$shop_id == ]
a <- data_pred[data_pred$shop_id == 1464]
a <- data_pred[data_pred$shop_id == 1464,]
a <- shop_pay[shop_pay$shop_id == 1464,]
View(a)
a <- shop_pay[shop_pay$shop_id == 1053,]
View(a)
data_pred_dcast$exceed_sd <- apply(data_pred_dcast,1,function(x){
sum(x < mean(x,na.rm = T) - sd(x,na.rm = T)*1.5 | x > mean(x,na.rm = T) + sd(x,na.rm = T)*1.5)
})
View(data_pred_dcast)
data_pred_dcast <- dcast(shop_id~uni_time,data = data_pred,value.var = 'value')
data_pred_dcast$num_na <- apply(data_pred_dcast,1,function(x)sum(is.na(x)))
data_pred_dcast$mean <- apply(data_pred_dcast,1,mean)
data_pred_dcast$sd <- apply(data_pred_dcast,1,sd)
data_pred_dcast$exceed_sd <- apply(data_pred_dcast,1,function(x){
sum(x < mean(x,na.rm = T) - sd(x,na.rm = T)*1.5 | x > mean(x,na.rm = T) + sd(x,na.rm = T)*1.5)
})
data_pred_dcast <- dcast(shop_id~uni_time,data = data_pred,value.var = 'value')
data_pred_dcast$num_na <- apply(data_pred_dcast[,2:8],1,function(x)sum(is.na(x)))
data_pred_dcast$mean <- apply(data_pred_dcast[,2:8],1,mean)
data_pred_dcast$sd <- apply(data_pred_dcast[,2:8],1,sd)
data_pred_dcast$exceed_sd <- apply(data_pred_dcast[,2:8],1,function(x){
sum(x < mean(x,na.rm = T) - sd(x,na.rm = T)*1.5 | x > mean(x,na.rm = T) + sd(x,na.rm = T)*1.5)
})
View(data_pred_dcast)
data_pred_dcast[1464,2:8]
data_pred_dcast <- dcast(shop_id~uni_time,data = data_pred,value.var = 'value')
data_pred_dcast$num_na <- apply(data_pred_dcast[,2:8],1,function(x)sum(is.na(x)))
data_pred_dcast$mean <- apply(data_pred_dcast[,2:8],1,mean,na.rm = T)
data_pred_dcast$sd <- apply(data_pred_dcast[,2:8],1,sd,na.rm = T)
data_pred_dcast$exceed_sd <- apply(data_pred_dcast[,2:8],1,function(x){
sum(x < mean(x,na.rm = T) - sd(x,na.rm = T)*1.5 | x > mean(x,na.rm = T) + sd(x,na.rm = T)*1.5)
})
data_pred_dcast$exceed_sd <- apply(data_pred_dcast[,2:8],1,function(x){
x <- x[!is.na(x)]
sum(x < mean(x) - sd(x)*1.5 | x > mean(x) + sd(x)*1.5)
})
View(data_pred_dcast)
data_pred_dcast$exceed_sd <- apply(data_pred_dcast[,2:8],1,function(x){
x <- x[!is.na(x)]
sum(x < mean(x) - sd(x)*3 | x > mean(x) + sd(x)*3)
})
View(data_pred_dcast)
data_pred_dcast$exceed_sd <- apply(data_pred_dcast[,2:8],1,function(x){
x <- x[!is.na(x)]
sum(x < mean(x) - sd(x)*2 | x > mean(x) + sd(x)*2)
})
data_pred_dcast$sdrate <- data_pred_dcast$sd/data_pred_dcast$mean
View(data_pred_dcast)
data_pred_melt <- melt(data_pred_dcast[,1:8],id.vars = 'shop_id')
View(data_pred_dcast)
View(data_pred_melt)
View(data_pred)
data_pred_melt <- melt(data_pred_dcast[,1:8],id.vars = 'shop_id',variable.name = 'uni_time')
data_pred_melt$uni_time <- as.p(data_pred_melt$uni_time)
View(data_pred_melt)
extract_data <- function(shop_pay){
data_pred <- subset(shop_pay,uni_time >= (test_start - 86400*k) & uni_time < test_start)
broken_shop <- dcast(shop_id~uni_time,data = data_pred,value.var = 'value')
broken_shop$num_na <- apply(broken_shop,1,function(x)sum(is.na(x)))
missing_shop <- c(broken_shop$shop_id[broken_shop$num_na >= 3],
setdiff(unique(shop_pay$shop_id),unique(data_pred$shop_id)))
weekday_end <- as.POSIXlt(test_end - 86400)$wday
missing_data <- lapply(missing_shop,function(i){
shop_data <- subset(shop_pay,shop_id == i & uni_time < (test_start - 86400*k))
last_day <- max(shop_data$uni_time[as.POSIXlt(shop_data$uni_time)$wday == weekday_end]) + 86400
md <- subset(shop_data,uni_time < last_day & uni_time >= (last_day - 86400*k))
md$uni_time <- md$uni_time + difftime(test_start,last_day,units = 'secs')
md
})
missing_data <- do.call(rbind,missing_data)
data_pred <- rbind(subset(data_pred,!(shop_id %in% missing_shop)),missing_data)
}
clear_data <- function(data_pred){
data_pred_dcast <- dcast(shop_id~uni_time,data = data_pred,value.var = 'value')
data_pred_dcast$num_na <- apply(data_pred_dcast[,2:8],1,function(x)sum(is.na(x)))
data_pred_dcast$mean <- apply(data_pred_dcast[,2:8],1,mean,na.rm = T)
data_pred_dcast$sd <- apply(data_pred_dcast[,2:8],1,sd,na.rm = T)
data_pred_dcast$sdrate <- data_pred_dcast$sd/data_pred_dcast$mean
data_pred_dcast[352,6:7] <- 308
data_pred_dcast[363,7] <- 63
data_pred_dcast[459,4] <- 25
data_pred_dcast[547,3] <- 52
data_pred_dcast[632,8] <- 14
data_pred_dcast[722,4] <- 130
data_pred_dcast[1053,3:4] <- 19
data_pred_dcast[1464,2:5] <- 2
data_pred_dcast[1661,4:5] <- 469
data_pred_melt <- melt(data_pred_dcast[,1:8],id.vars = 'shop_id',variable.name = 'uni_time')
data_pred_melt$uni_time <- as.p(data_pred_melt$uni_time)
list(data_pred_melt,data_pred_dcast)
}
expand_data <- function(data_pred,k){
rp <- ceiling(14/k)
data_pred_expand <- lapply(seq_len(rp),function(i){
data_pred$uni_time <- data_pred$uni_time + 86400 * k * i
data_pred
})
data_pred_expand <- do.call(rbind,data_pred_expand)
}
add_real <- function(data_pred){
data_pred <- subset(data_pred,uni_time >= test_start & uni_time < test_end)
data_real <- subset(shop_pay,uni_time >= test_start & uni_time < test_end)
data_comp <- merge(data_real,data_pred,by = c('shop_id','uni_time'))
names(data_comp) <- c('shop_id','uni_time','value','pred')
data_comp
}
k = 7
data_pred <- extract_data(shop_pay)
list[data_pred,data_pred_dcast] <- clear_data(data_pred)
data_pred <- expand_data(data_pred,k)
data_comp <- add_real(data_pred)
data_real <- subset(shop_pay,uni_time >= test_start & uni_time < test_end)
data_comp <- add_real(data_pred)
cat(sprintf('Last %.0f days\t',k))
if(nrow(data_comp) == 0){
return(data_pred)
}else{
r <- check_result(data_comp)
return(list(r,data_comp))
}
View(data_comp)
r <- check_result(data_comp)
source('D:/Git/TC_koubei/check_result.R')
if(nrow(data_comp) == 0){
return(data_pred)
}else{
r <- check_result(data_comp)
return(list(r,data_comp))
}
r <- check_result(data_comp)
source('D:/Git/TC_koubei/gen_result_last_week_Func.R')
rm(list = ls())
source('head.R')
source('gen_result_last_week_Func.R')
load(file.path(dir_data,'shop_pay.Rda'))
rm(list = ls())
source('head.R')
source('gen_result_last_week_Func.R')
load(file.path(dir_data,'shop_pay.Rda'))
load(file.path(dir_data,'shop_info.Rda'))
# test_end <- as.p('2016-11-01')
test_end <- as.p('2016-11-15')
test_start <- test_end - 14*86400
data_pred <- extract_data(shop_pay)
source('D:/Git/TC_koubei/gen_result_last_week_Func.R')
rm(list = ls())
source('head.R')
source('gen_result_last_week_Func.R')
load(file.path(dir_data,'shop_pay.Rda'))
load(file.path(dir_data,'shop_info.Rda'))
# test_end <- as.p('2016-11-01')
test_end <- as.p('2016-11-15')
test_start <- test_end - 14*86400
k <- 7
data_pred <- extract_data(shop_pay,k)
list[data_pred,data_pred_dcast] <- clear_data(data_pred)
data_pred_dcast <- dcast(shop_id~uni_time,data = data_pred,value.var = 'value')
rm(list = ls())
source('head.R')
source('gen_result_last_week_Func.R')
load(file.path(dir_data,'shop_pay.Rda'))
load(file.path(dir_data,'shop_info.Rda'))
# test_end <- as.p('2016-11-01')
test_end <- as.p('2016-11-15')
test_start <- test_end - 14*86400
k <- 7
data_pred <- extract_data(shop_pay,k)
length(unique(data_pred$shop_id))
rm(list = ls())
source('head.R')
source('gen_result_last_week_Func.R')
load(file.path(dir_data,'shop_pay.Rda'))
load(file.path(dir_data,'shop_info.Rda'))
# test_end <- as.p('2016-11-01')
test_end <- as.p('2016-11-15')
test_start <- test_end - 14*86400
k <- 7
data_pred <- extract_data(shop_pay,k)
data_pred_dcast <- dcast(shop_id~uni_time,data = data_pred,value.var = 'value')
data_pred_dcast$num_na <- apply(data_pred_dcast[,2:8],1,function(x)sum(is.na(x)))
data_pred_dcast$mean <- apply(data_pred_dcast[,2:8],1,mean,na.rm = T)
data_pred_dcast$sd <- apply(data_pred_dcast[,2:8],1,sd,na.rm = T)
data_pred_dcast$sdrate <- data_pred_dcast$sd/data_pred_dcast$mean
View(data_pred_dcast)
a <- subset(data_pred_dcast,num_na != 0 )
View(a)
names(a) <- 1:12
mean(c(dpd[5,c(2,5)]))
mean(c(data_pred_dcast[5,c(2,5)]))
data_pred_dcast[5,c(2,5)]
mean(data_pred_dcast[5,c(2,5)])
data_pred_dcast[5,c(2,5)]
(302+215)/2
data_pred_dcast[5,3:4] <- (302+215)/2
data_pred_dcast[444,3:4] <- (76+290)/2
data_pred_dcast[470,3:4] <- (55+86)/2
data_pred_dcast[513,6] <- (167+85)/2
data_pred_dcast[547,3] <- (99+59)/2
data_pred_dcast[632,2] <- (12+36)/2
data_pred_dcast[659,1] <- (21+28)/2
data_pred_dcast[987,8] <- 37
data_pred_dcast[1163,5] <- (102+28)/2
data_pred_dcast[1185,3] <- (341+346)/2
data_pred_dcast[1486,1] <- 51
data_pred_dcast[1556,2:4] <- (200+195)/2
data_pred_dcast[1716,6:7] <- (151+190)/2
data_pred_dcast[1831,6:7] <- (661+679)/2
data_pred_dcast[1858,2:3] <- (51+57)/2
data_pred_dcast[1918,4] <- 6
data_pred_dcast[1959,1] <- (490+407)/2
View(data_pred)
View(data_pred_dcast)
rm(list = ls())
source('head.R')
source('gen_result_last_week_Func.R')
load(file.path(dir_data,'shop_pay.Rda'))
load(file.path(dir_data,'shop_info.Rda'))
# test_end <- as.p('2016-11-01')
test_end <- as.p('2016-11-15')
test_start <- test_end - 14*86400
k <- 7
data_pred <- extract_data(shop_pay,k)
data_pred_dcast <- dcast(shop_id~uni_time,data = data_pred,value.var = 'value')
data_pred_dcast$num_na <- apply(data_pred_dcast[,2:8],1,function(x)sum(is.na(x)))
data_pred_dcast$mean <- apply(data_pred_dcast[,2:8],1,mean,na.rm = T)
data_pred_dcast$sd <- apply(data_pred_dcast[,2:8],1,sd,na.rm = T)
data_pred_dcast$sdrate <- data_pred_dcast$sd/data_pred_dcast$mean
data_pred_dcast[5,3:4] <- (302+215)/2
data_pred_dcast[444,3:4] <- (76+290)/2
data_pred_dcast[470,3:4] <- (55+86)/2
data_pred_dcast[513,6] <- (167+85)/2
data_pred_dcast[547,3] <- (99+59)/2
data_pred_dcast[632,2] <- (12+36)/2
data_pred_dcast[659,2] <- (21+28)/2
data_pred_dcast[987,8] <- 37
data_pred_dcast[1163,5] <- (102+28)/2
data_pred_dcast[1185,3] <- (341+346)/2
data_pred_dcast[1486,2] <- 51
data_pred_dcast[1556,2:4] <- (200+195)/2
data_pred_dcast[1716,6:7] <- (151+190)/2
data_pred_dcast[1831,6:7] <- (661+679)/2
data_pred_dcast[1858,2:3] <- (51+57)/2
data_pred_dcast[1918,4] <- 6
data_pred_dcast[1959,2] <- (490+407)/2
View(data_pred_dcast)
data_pred_dcast <- as.integer(data_pred_dcast[,1:8])
data_pred_dcast[,1:8] <- as.integer(data_pred_dcast[,1:8])
data_pred_dcast[,1:8] <- round(data_pred_dcast[,1:8])
data_pred_dcast <- dcast(shop_id~uni_time,data = data_pred,value.var = 'value')
data_pred_dcast$num_na <- apply(data_pred_dcast[,2:8],1,function(x)sum(is.na(x)))
data_pred_dcast$mean <- apply(data_pred_dcast[,2:8],1,mean,na.rm = T)
data_pred_dcast$sd <- apply(data_pred_dcast[,2:8],1,sd,na.rm = T)
data_pred_dcast$sdrate <- data_pred_dcast$sd/data_pred_dcast$mean
data_pred_dcast[5,3:4] <- (302+215)/2
data_pred_dcast[444,3:4] <- (76+290)/2
data_pred_dcast[470,3:4] <- (55+86)/2
data_pred_dcast[513,6] <- (167+85)/2
data_pred_dcast[547,3] <- (99+59)/2
data_pred_dcast[632,2] <- (12+36)/2
data_pred_dcast[659,2] <- (21+28)/2
data_pred_dcast[987,8] <- 37
data_pred_dcast[1163,5] <- (102+28)/2
data_pred_dcast[1185,3] <- (341+346)/2
data_pred_dcast[1486,2] <- 51
data_pred_dcast[1556,2:4] <- (200+195)/2
data_pred_dcast[1716,6:7] <- (151+190)/2
data_pred_dcast[1831,6:7] <- (661+679)/2
data_pred_dcast[1858,2:3] <- (51+57)/2
data_pred_dcast[1918,4] <- 6
data_pred_dcast[1959,2] <- (490+407)/2
data_pred_dcast[,1:8] <- round(data_pred_dcast[,1:8])
data_pred_dcast$num_na <- apply(data_pred_dcast[,2:8],1,function(x)sum(is.na(x)))
data_pred_dcast$mean <- apply(data_pred_dcast[,2:8],1,mean,na.rm = T)
data_pred_dcast$sd <- apply(data_pred_dcast[,2:8],1,sd,na.rm = T)
data_pred_dcast$sdrate <- data_pred_dcast$sd/data_pred_dcast$mean
data_pred <- extract_data(shop_pay,k)
list[data_pred,data_pred_dcast] <- fill_missing_data(data_pred)
data_pred <- expand_data(data_pred,k)
data_comp <- add_real(data_pred)
cat(sprintf('Last %.0f days\t',k))
if(nrow(data_comp) == 0){
return(data_pred)
}else{
r <- check_result(data_comp)
return(list(r,data_comp))
}
View(data_pred)
r7a <- dcast(shop_id~uni_time,data = data_pred,value.var = 'value')
r7 <- dcast(shop_id~uni_time,data = data_pred,value.var = 'value')
names(r7) <- c('shop_id',paste('day_',1:14,sep=''))
source('D:/Git/TC_koubei/gen_result_last_week_Func.R')
source('D:/Git/TC_koubei/gen_result_last_week.R')
source('D:/Git/TC_koubei/gen_result_last_week_Func.R')
source('D:/Git/TC_koubei/gen_result_last_week.R')
nrow(data_comp) == 0
source('D:/Git/TC_koubei/gen_result_last_week.R')
View(r)
summary(r)
r7 <- dcast(shop_id~uni_time,data = data_pred,value.var = 'value')
names(r7) <- c('shop_id',paste('day_',1:14,sep=''))
r7 <- r7[order(r7$shop_id),]
write.table(r7,file = file.path(dir_data,'title'),quote = F,sep=',',row.names = F,col.names = F)
file.path(dir_data,'title')
source('D:/Git/TC_koubei/gen_result_last_week_Func.R')
source('D:/Git/TC_koubei/gen_result_last_week.R')
